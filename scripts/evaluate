#!/usr/bin/env bash

echo $(date) "Evaluation"

USAGE="evaluate --input [dir] --tracks [dir] --output [dir] --config [json]"
while [[ "$#" > 1 ]]; do case $1 in
    --input)  input_evaluate="$2";;
    --tracks) tracks_evaluate="$2";;
    --output) output_evaluate="$2";;
    --config) config_evaluate="$2";;
    *) echo "Usage: $USAGE"; exit 1;;
  esac; shift; shift
done

if  [[ -z "$input_evaluate"   ]] || \
    [[ -z "$tracks_evaluate"  ]] || \
    [[ -z "$output_evaluate"  ]] || \
    [[ -z "$config_evaluate"  ]] ; then
  echo "Usage: $USAGE"
  exit 1
fi

mkdir $output_evaluate

echo $(date) >> $output_evaluate/log.txt

./modules/evaluate/make_seq_list.py \
	--input $input_evaluate \
	--tracks $tracks_evaluate \
	--output $output_evaluate/seqs.csv \
	>> $output_evaluate/log.txt

echo $(date) "Evaluation: Converting MOT to JSONs"
./modules/evaluate/mot2json.py \
	--input $output_evaluate/seqs.csv \
	--output $output_evaluate/jsons \
	>> $output_evaluate/log.txt

echo $(date) "Evaluation: Computing CLEAR MOT stats"
mkdir $output_evaluate/stat
for i in $(ls $input_evaluate)
do
  ./modules/evaluate/pymot/pymot.py \
  	-a $output_evaluate/jsons/$i/groundtruth.json \
  	-b $output_evaluate/jsons/$i/hypotheses.json \
  	> $output_evaluate/stat/$i.stat
done

echo $(date) "Evaluation: Summarizing the stats"
./modules/evaluate/evaluate.py --input $output_evaluate/stat/
