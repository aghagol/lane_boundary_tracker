#!/usr/bin/env bash

echo -e "\033[1;31m"$(date)"\033[0m" "Evaluation"

USAGE="evaluate --input [dir] --tracks [dir] --output [dir] --config [json]"
while [[ "$#" > 1 ]]; do case $1 in
    --input)  INPUT_EVALUATE="$2";;
    --tracks) TRACKS_EVALUATE="$2";;
    --output) OUTPUT_EVALUATE="$2";;
    --config) CONFIG_EVALUATE="$2";;
    *) echo "Usage: $USAGE"; exit 1;;
  esac; shift; shift
done

if  [[ -z "$INPUT_EVALUATE"   ]] || \
    [[ -z "$TRACKS_EVALUATE"  ]] || \
    [[ -z "$OUTPUT_EVALUATE"  ]] || \
    [[ -z "$CONFIG_EVALUATE"  ]] ; then
  echo "Usage: $USAGE"
  exit 1
fi

mkdir $OUTPUT_EVALUATE

echo $(date) >> $OUTPUT_EVALUATE/log.txt

./modules/evaluate/make_seq_list.py \
	--input $INPUT_EVALUATE \
	--tracks $TRACKS_EVALUATE \
	--output $OUTPUT_EVALUATE/seqs.csv \
	>> $OUTPUT_EVALUATE/log.txt

echo $(date) "Evaluation: Converting MOT to JSONs"
./modules/evaluate/mot2json.py \
	--input $OUTPUT_EVALUATE/seqs.csv \
	--output $OUTPUT_EVALUATE/jsons \
	>> $OUTPUT_EVALUATE/log.txt

echo $(date) "Evaluation: Computing CLEAR MOT stats"
mkdir $OUTPUT_EVALUATE/stat
for i in $(ls $INPUT_EVALUATE)
do
  ./modules/evaluate/pymot/pymot.py \
  	-a $OUTPUT_EVALUATE/jsons/$i/groundtruth.json \
  	-b $OUTPUT_EVALUATE/jsons/$i/hypotheses.json \
  	> $OUTPUT_EVALUATE/stat/$i.stat
done

echo $(date) "Evaluation: Summarizing the stats"
./modules/evaluate/evaluate.py --input $OUTPUT_EVALUATE/stat/
