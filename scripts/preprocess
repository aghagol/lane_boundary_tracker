#!/usr/bin/env bash

echo $(date) "Preprocessing"

USAGE="preprocess --input [dir] --output [dir] --config [json] --drives [txt] --poses [dir] --tagged [dir]"
while [[ "$#" > 1 ]]; do case $1 in
    --input)  input_preprocess="$2";;
    --output) output_preprocess="$2";;
    --config) config_preprocess="$2";;
    --drives) drive_list="$2";;
    --poses)  poses_preprocess="$2";;
    --tagged) tagged_preprocess="$2";;
    *) echo "Usage: $USAGE"; exit 1;;
  esac; shift; shift
done

if  [[ -z "$input_preprocess"   ]] || \
    [[ -z "$output_preprocess"  ]] || \
    [[ -z "$config_preprocess"  ]] || \
    [[ -z "$drive_list"         ]] || \
    [[ -z "$poses_preprocess"   ]] || \
    [[ -z "$tagged_preprocess"  ]] ; then
  echo "Usage: $USAGE"
  exit 1
fi

mkdir $output_preprocess

./modules/preprocess/print_param.py --config $config_preprocess

echo $(date) >> $output_preprocess/log.txt

./modules/preprocess/log_param.py \
  --config $config_preprocess \
  >> $output_preprocess/log.txt

./modules/preprocess/gen_drive_list.py \
  --input  $input_preprocess \
  --drives $drive_list \
  >> $output_preprocess/log.txt

echo $(date) "Preprocessing: Tagging (timestamps)"
./modules/preprocess/gen_tagged.py \
  --input  $input_preprocess \
  --poses  $poses_preprocess \
  --output $tagged_preprocess \
  --config $config_preprocess \
  --drives $drive_list \
  >> $output_preprocess/log.txt

echo $(date) "Preprocessing: Generating MOT"
./modules/preprocess/gen_mot.py \
  --input  $tagged_preprocess \
  --poses  $poses_preprocess \
  --output $output_preprocess/mot \
  --config $config_preprocess \
  --drives $drive_list \
  >> $output_preprocess/log.txt
