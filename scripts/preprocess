#!/usr/bin/env bash

while [[ "$#" > 1 ]]; do case $1 in
    --images)     IMAGES_PREPROCESS="$2";;
    --output)     OUTPUT_PREPROCESS="$2";;
    --config)     CONFIG_PREPROCESS="$2";;
    --drives)     DRIVELIST_PREPROCESS="$2";;
    --poses)      POSES_PREPROCESS="$2";;
    --tagged)     TAGGED_PREPROCESS="$2";;
    --fuses)      FUSES_PREPROCESS="$2";;
    --verbosity)  VERBOSITY_PREPROCESS="$2";;
    *) echo "Preprocessing: usage error"; exit 1;;
  esac; shift; shift
done

if [[ $VERBOSITY_PREPROCESS -ge 1 ]] ; then
  echo -e "\033[1;31m"$(date)"\033[0m" "Preprocessing"
fi

mkdir -p $OUTPUT_PREPROCESS

./modules/preprocess/print_param.py \
  --config    $CONFIG_PREPROCESS \
  --verbosity $VERBOSITY_PREPROCESS

./modules/preprocess/generate_drive_list.py \
  --images    $IMAGES_PREPROCESS \
  --drives    $DRIVELIST_PREPROCESS \
  --verbosity $VERBOSITY_PREPROCESS

if [[ $VERBOSITY_PREPROCESS -ge 1 ]] ; then
  echo -e "\033[1;31m"$(date)"\033[0m" "Preprocessing: Extracting detection points"
fi
./modules/preprocess/extract_points.py \
  --images    $IMAGES_PREPROCESS \
  --config    $CONFIG_PREPROCESS \
  --drives    $DRIVELIST_PREPROCESS \
  --fuses     $FUSES_PREPROCESS \
  --output    $OUTPUT_PREPROCESS \
  --verbosity $VERBOSITY_PREPROCESS

if [[ $VERBOSITY_PREPROCESS -ge 1 ]] ; then
  echo -e "\033[1;31m"$(date)"\033[0m" "Preprocessing: Tagging (timestamps)"
fi
./modules/preprocess/tag_points.py \
  --fuses     $FUSES_PREPROCESS \
  --tagged    $TAGGED_PREPROCESS \
  --images    $IMAGES_PREPROCESS \
  --poses     $POSES_PREPROCESS \
  --config    $CONFIG_PREPROCESS \
  --drives    $DRIVELIST_PREPROCESS \
  --verbosity $VERBOSITY_PREPROCESS

if [[ $VERBOSITY_PREPROCESS -ge 1 ]] ; then
  echo -e "\033[1;31m"$(date)"\033[0m" "Preprocessing: Generating MOT"
fi
./modules/preprocess/generate_MOT_data.py \
  --tagged    $TAGGED_PREPROCESS \
  --output    $OUTPUT_PREPROCESS \
  --poses     $POSES_PREPROCESS \
  --config    $CONFIG_PREPROCESS \
  --drives    $DRIVELIST_PREPROCESS \
  --verbosity $VERBOSITY_PREPROCESS
