#!/usr/bin/env bash

USAGE="runall \
  --fuses     path/to/fuse_data \
  --cache     path/to/tmp \
  --drives    txt_file \
  --poses     path/to/pose_csv \
  --chunks    path/to/chunks_metadata \
  --tagged    path/to/tagged_data\
  --tracker   tracking_method\
  --config    config_json"

while [[ "$#" > 1 ]]; do case $1 in
    --fuses)    FUSES_PATH="$2";;
    --cache)    CACHE="$2";;
    --drives)   DRIVE_LIST="$2";;
    --poses)    POSES_PATH="$2";;
    --tagged)   TAGGED_PATH="$2";;
    --chunks)   CHUNKS_PATH="$2";;
    --tracker)  TRACKER="$2";;
    --config)   CONFIG="$2";;
    *) echo "Usage: $USAGE"; exit 1;;
  esac; shift; shift
done

if [[ -z $CACHE ]] ; then
  echo "Usage: $USAGE"; exit 1
fi

if [[ $FUSES_PATH ]] ; then
  if mkdir $CACHE ; then
    if [[ -z $DRIVE_LIST ]] ; then
      echo "Saving the drive names in $CACHE/preprocess"
      DRIVE_LIST=$CACHE/preprocess/drive_list.txt
    fi
    ./scripts/preprocess  --input $FUSES_PATH           --output $CACHE/preprocess  --config $CONFIG  --drives $DRIVE_LIST  --poses $POSES_PATH  --tagged $TAGGED_PATH
    ./scripts/$TRACKER    --input $CACHE/preprocess/mot --output $CACHE/$TRACKER    --config $CONFIG
    ./scripts/postprocess --input $CACHE/preprocess/mot --output $CACHE/postprocess --config $CONFIG  --tracks $CACHE/$TRACKER/tracks
    ./scripts/fuse        --input $CACHE/preprocess/mot --output $CACHE/fuse        --config $CONFIG  --tracks $CACHE/postprocess/tracks  --chunks $CHUNKS_PATH --tagged $TAGGED_PATH
    # ./scripts/evaluate    --input $CACHE/preprocess/mot --output $CACHE/evaluate    --config $CONFIG  --tracks $CACHE/$TRACKER/tracks
  else
    echo "Output path exists.. Please enter another path for outputs."
  fi
fi

read -sp "Press [ENTER] to Visualize"; echo ""
rm -rf $CACHE/visualize
./scripts/visualize --input $CACHE/preprocess/mot --output $CACHE/visualize --config $CONFIG --tracks $CACHE/postprocess/tracks

