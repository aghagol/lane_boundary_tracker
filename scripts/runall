#!/usr/bin/env bash

USAGE="runall --input   path/to/input_data_dir \
              --images  path/to/CNN_predictions \
              --fuses   path/to/fuse_files \
              --tagged  path/to/tagged_fuse_files \
              --cache   path/to/cache \
              --drives  list_of_drives_txt_file \
              --poses   path/to/pose_csv_files \
              --chunks  path/to/chunk_metadata \
              --tracker tracking_method_name \
              --config  configuration_json_file"

while [[ "$#" > 1 ]]; do case $1 in
    --input)    INPUT_PATH="$2";;
    --images)   IMAGES_PATH="$2";;
    --fuses)    FUSE_PATH="$2";;
    --tagged)   TAGGED_PATH="$2";;
    --cache)    CACHE="$2";;
    --drives)   DRIVE_LIST="$2";;
    --poses)    POSE_PATH="$2";;
    --chunks)   CHUNK_PATH="$2";;
    --tracker)  TRACKER="$2";;
    --config)   CONFIG="$2";;
    *) echo "Usage: $USAGE"; exit 1;;
  esac; shift; shift
done

if [[ -z $CACHE ]] ; then
  echo "Usage: $USAGE"; exit 1
fi

mkdir -p $CACHE

if [[ $INPUT_PATH ]] ; then
  if [[ -z $DRIVE_LIST ]] ; then
    echo "Saving the drive names in $CACHE/preprocess"
    DRIVE_LIST=$CACHE/preprocess/drive_list.txt
  fi
  ./scripts/preprocess  --input $INPUT_PATH  --images $IMAGES_PATH  --output $CACHE/preprocess  --config $CONFIG  --drives $DRIVE_LIST  --poses $POSE_PATH  --tagged $TAGGED_PATH --fuses $FUSE_PATH
  ./scripts/$TRACKER    --input $CACHE/preprocess/mot --output $CACHE/$TRACKER    --config $CONFIG
  ./scripts/postprocess --input $CACHE/preprocess/mot --output $CACHE/postprocess --config $CONFIG  --tracks $CACHE/$TRACKER/tracks
  ./scripts/fuse        --input $CACHE/preprocess/mot --output $CACHE/fuse        --config $CONFIG  --tracks $CACHE/postprocess/tracks  --chunks $CHUNK_PATH
  # ./scripts/evaluate    --input $CACHE/preprocess/mot --cache $CACHE/evaluate    --config $CONFIG  --tracks $CACHE/sort/tracks
fi

read -sp "Press [ENTER] to Visualize"; echo ""
rm -rf $CACHE/visualize
./scripts/visualize --input $CACHE/preprocess/mot --output $CACHE/visualize --config $CONFIG --tracks $CACHE/postprocess/tracks

